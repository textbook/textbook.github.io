<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width">
  <title>Publishing npm packages with service accounts</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://blog.jonrshar.pe/theme/css/main.3dad1b7a.css">
  <style media="print">.is-hidden-print{display:none !important}</style>
      <link rel="stylesheet" href="https://blog.jonrshar.pe/custom.css">
<meta property="og:title" content="textbook - Publishing npm packages with service accounts">
  <meta property="og:description" content="2FA adds security to your npm account but complicates the process of publishing from CI; here's one way around that">
<meta property="og:url" content="https://blog.jonrshar.pe/2019/Jan/14/npm-service-accounts.html">
    <meta property="og:image" content="https://blog.jonrshar.pe/images/fauxauth-maintainers.png">
    <meta name="twitter:image:alt" content="textbook | These are my opinions - if you don't like them, I have others">
<meta name="twitter:card" content="summary">
  <meta name="twitter:creator" content="@jonrsharpe">
  <meta name="twitter:site" content="@jonrsharpe">
<meta property="og:site_name" content="textbook">
<meta property="og:type" content="article">
  <meta property="article:published_time" content="2019-01-14T19:40:00+00:00">
  <meta property="article:modified_time" content="2020-11-01T12:30:00+00:00">
    <meta property="article:tag" content="code">
    <meta property="article:tag" content="javascript">
    <meta property="article:tag" content="ci">
    <meta property="article:tag" content="npm">
  <meta property="article:section" content="development">
</head>

<body id="index" class="home">
<header class="hero is-primary">
  <div class="hero-head">
    <div class="container">
      <nav class="navbar">
        <div class="navbar-brand">
          <a class="navbar-item title is-3"
             href="https://blog.jonrshar.pe/">textbook</a>
        </div>
      </nav>
    </div>
  </div>
</header>

<nav class="navbar has-shadow is-hidden-print">
  <div class="container">
    <div class="navbar-center"></div>
    <span id="navToggle" class="navbar-burger">
      <span></span>
      <span></span>
      <span></span>
    </span>
    <div id="navMenu" class="navbar-menu">
        <div class="navbar-end">
              <a class="navbar-item is-tab "
                 href="https://blog.jonrshar.pe/category/work.html">work</a>
              <a class="navbar-item is-tab "
                 href="https://blog.jonrshar.pe/category/meta.html">meta</a>
              <a class="navbar-item is-tab is-active"
                 href="https://blog.jonrshar.pe/category/development.html">development</a>
        </div>
    </div>
  </div>
</nav>

<div class="container">
  <div class="section columns">
    <div class="column is-three-quarters-desktop is-two-thirds-tablet">
<section id="content" class="body">
  <article>
    <h1 class="title">
      <a href="https://blog.jonrshar.pe/2019/Jan/14/npm-service-accounts.html" rel="bookmark"
         title="Permalink to Publishing npm packages with service accounts">Publishing npm packages with service accounts</a></h1>
<footer class="post-info">
  <abbr class="published" title="2019-01-14T19:40:00+00:00">
    Published <span class="is-info">Mon 14 January 2019</span>
    in <a href="https://blog.jonrshar.pe/category/development.html">development</a>
  </abbr>
    <br />
    <abbr class="modified" title="2020-11-01T12:30:00+00:00">
      Updated Sun 01 November 2020
    </abbr>

    <p class="author">
      <em>by           Jonathan Sharpe
</em>
      <span class="tag is-small is-rounded">
        <a href="https://blog.jonrshar.pe/tag/code.html">code</a>
      </span>
      <span class="tag is-small is-rounded">
        <a href="https://blog.jonrshar.pe/tag/javascript.html">javascript</a>
      </span>
      <span class="tag is-small is-rounded">
        <a href="https://blog.jonrshar.pe/tag/ci.html">ci</a>
      </span>
      <span class="tag is-small is-rounded">
        <a href="https://blog.jonrshar.pe/tag/npm.html">npm</a>
      </span>
    </p>
  
</footer>    <div class="section"><blockquote>
<p><strong>Update</strong>: In <a href="https://github.blog/changelog/2020-10-02-npm-automation-tokens/">October 2020</a> NPM added the option to generate Automation
tokens, which bypass 2FA even for accounts that have it enabled for
publication. Using service accounts still improves security by reducing the
number of packages a successful attacker gets access to, so the below
information may still be useful to you.</p>
</blockquote>
<p>Since October 2017, npm has supported <a href="https://blog.npmjs.org/post/166039777883/protect-your-npm-account-with-two-factor">2-factor authentication</a> (2FA). This
is good for security, and I've enabled it for both authorisation and publication
on my main account, but it's difficult to use if you want to publish packages
automatically from CI (e.g. using <a href="https://docs.travis-ci.com/user/deployment/npm/">Travis CI</a>):</p>
<div class="highlight"><pre><span></span><code><span class="nv">npm</span><span class="w"> </span><span class="nv">ERR</span><span class="o">!</span><span class="w"> </span><span class="nv">publish</span><span class="w"> </span><span class="nv">Failed</span><span class="w"> </span><span class="nv">PUT</span><span class="w"> </span><span class="mi">401</span>
<span class="nv">npm</span><span class="w"> </span><span class="nv">ERR</span><span class="o">!</span><span class="w"> </span><span class="nv">code</span><span class="w"> </span><span class="nv">E401</span>
<span class="nv">npm</span><span class="w"> </span><span class="nv">ERR</span><span class="o">!</span><span class="w"> </span><span class="nv">This</span><span class="w"> </span><span class="nv">operation</span><span class="w"> </span><span class="nv">requires</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">one</span><span class="o">-</span><span class="nv">time</span><span class="w"> </span><span class="nv">password</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">your</span><span class="w"> </span><span class="nv">authenticator</span>.
<span class="nv">npm</span><span class="w"> </span><span class="nv">ERR</span><span class="o">!</span><span class="w"> </span><span class="nv">You</span><span class="w"> </span><span class="nv">can</span><span class="w"> </span><span class="nv">provide</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">one</span><span class="o">-</span><span class="nv">time</span><span class="w"> </span><span class="nv">password</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nv">passing</span><span class="w"> </span><span class="o">--</span><span class="nv">otp</span><span class="o">=&lt;</span><span class="nv">code</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">command</span><span class="w"> </span><span class="nv">you</span><span class="w"> </span><span class="nv">ran</span>.
<span class="nv">npm</span><span class="w"> </span><span class="nv">ERR</span><span class="o">!</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="nv">you</span><span class="w"> </span><span class="nv">already</span><span class="w"> </span><span class="nv">provided</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">one</span><span class="o">-</span><span class="nv">time</span><span class="w"> </span><span class="nv">password</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">likely</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">you</span><span class="w"> </span><span class="nv">either</span><span class="w"> </span><span class="nv">typoed</span>
<span class="nv">npm</span><span class="w"> </span><span class="nv">ERR</span><span class="o">!</span><span class="w"> </span><span class="nv">it</span>,<span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">timed</span><span class="w"> </span><span class="nv">out</span>.<span class="w"> </span><span class="nv">Please</span><span class="w"> </span><span class="nv">try</span><span class="w"> </span><span class="nv">again</span>.
</code></pre></div>

<p>I have found <a href="https://medium.com/@sgyio/how-to-deploy-npm-package-with-2fa-enabled-on-write-49843bf493a8">one proof of concept</a> method using Hashicorp's <a href="https://www.vaultproject.io/">Vault</a> to
provide a TOTP code as needed, but this requires a lot of external setup if
you're not already using Vault as part of your workflow.</p>
<p>Instead, I've set up a second, "service" account to use when publishing
from CI. Here's how:</p>
<ol>
<li>
<p>First, you need to create a new npm user to act as the service user for
    automated deploys. Unfortunately, npm doesn't currently give you a way to
    add a description to a user, but I've set the service user up with the same
    GitHub and Twitter handles as my main account, so it's hopefully clear who
    it belongs to. I've also given it a spiffy robot avatar via Gravatar. Enable
    2FA, but make sure it's only for <em>Authorization</em>, not <em>Authorization and
    Publishing</em>.</p>
</li>
<li>
<p>Next, create a token for use in the CI environment. Switch to the <em>Tokens</em>
    tab (or navigate directly to <code>https://www.npmjs.com/settings/{user}/tokens</code>)
    and click <em>Create New Token</em>. This will need to be set to the <em>Read and
    Publish</em> level.</p>
</li>
<li>
<p>Finally, log in with your main account, visit the package you want to give
    the service account access to and switch to the <em>Admin</em> tab (or navigate
    directly to <code>https://www.npmjs.com/package/{package}/access</code>). In the
    <strong>Invite maintainer</strong> section, type the name of your service account and
    click <em>Invite</em>. You should then see something like this:</p>
<p><img alt="fauxauth maintainers list" src="https://blog.jonrshar.pe/images/fauxauth-maintainers.png"></p>
</li>
</ol>
<p>You can use the service account token in your CI environment for automated
deploys, without needing to reduce the security of your main account. I'd
recommend creating one service account per package so a breach doesn't impact
multiple different projects (and, as always, using a password manager to create
long, secure passwords that aren't reused).</p>
<p>One major downside is that you can't enable the <em>"Require Two Factor
Authentication to publish or modify settings"</em> option for your package while
you're using non-2FA service accounts. If you have other maintainers, make sure
they <em>are</em> using full 2FA on their main accounts.</p></div>
    <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'textbook-dev';
        var disqus_identifier = '2019/Jan/14/npm-service-accounts.html';
        var disqus_url = 'https://blog.jonrshar.pe/2019/Jan/14/npm-service-accounts.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//textbook-dev.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>

  </article>
</section>

<script type="application/ld+json">
  {"articleSection": "development", "author": {"@type": "Person", "name": "Jonathan Sharpe"}, "datePublished": "2019-01-14T19:40:00+00:00", "headline": "Publishing npm packages with service accounts", "mainEntityOfPage": {"@type": "WebPage", "@id": "https://blog.jonrshar.pe/2019/Jan/14/npm-service-accounts.html"}, "@context": "http://schema.org", "@type": "BlogPosting", "dateModified": "2020-11-01T12:30:00+00:00", "description": "2FA adds security to your npm account but complicates the process of publishing from CI; here's one way around that", "image": {"@type": "ImageObject", "url": "https://blog.jonrshar.pe/images/fauxauth-maintainers.png"}}
</script>
    </div>

    <div class="column is-one-quarter-desktop is-one-third-tablet is-hidden-print">
      <aside class="menu">
<div id="mc_embed_signup">
  <form
      action="https://jonrshar.us15.list-manage.com/subscribe/post?u=7ada11180797f3af73228bf0b&amp;id=d172abcbd2"
      method="post" id="mc-embedded-subscribe-form"
      name="mc-embedded-subscribe-form" class="validate" target="_blank"
      novalidate>

    <h2 class="menu-label">Mailing List</h2>

    <div id="mc_embed_signup_scroll">
      <div class="field mc-field-group">
        <label for="mce-EMAIL" class="label is-small">Email</label>
        <div class="field-body">
          <div class="field">
            <p class="control has-icons-left">
              <input type="email" name="EMAIL" class="input required email is-small"
                     id="mce-EMAIL" placeholder="Email address">
              <span class="icon is-small is-left">
              <i class="fa fa-envelope"></i>
            </span>
            </p>
          </div>
        </div>
      </div>
      <div class="field">
        <label for="mce-FNAME" class="label is-small">Name</label>
        <div class="field-body">
          <div class="field is-grouped">
            <p class="control is-expanded">
              <input class="input is-small" type="text" value="" name="FNAME"
                     id="mce-FNAME" placeholder="First">
            </p>
            <p class="control is-expanded">
              <input class="input is-small" type="text" value="" name="LNAME"
                     id="mce-LNAME" placeholder="Last">
            </p>
          </div>
        </div>
      </div>
      <div class="field is-grouped">
        <p class="control">
          <input type="submit" name="subscribe" value="Subscribe"
                 class="button is-small is-success" id="mc-embedded-subscribe">
        </p>
          <p class="control">
            <span class="help">
              Powered by
              <a href="http://eepurl.com/cNv6Rb"
                 title="MailChimp - email marketing made easy and fun">
                MailChimp
              </a>
            </span>
          </p>
      </div>

      <div id="mce-responses" class="clear">
        <div class="response help is-danger" id="mce-error-response"
             style="display:none"></div>
        <div class="response help is-success" id="mce-success-response"
             style="display:none"></div>
      </div>

      <div style="position: absolute; left: -5000px;" aria-hidden="true">
        <input type="text" name="b_7ada11180797f3af73228bf0b_d172abcbd2"
               tabindex="-1" value="">
      </div>
    </div>
  </form>
</div>

          <p class="menu-label">Other Pages</p>
          <ul class="menu-list">
                <li><a                        href="https://blog.jonrshar.pe/pages/about.html">
                  <span class="icon is-small"><i class="fa fa-book"></i></span>
                  <span class="link-text">About</span>
                </a></li>
          </ul>
          <p class="menu-label">Links</p>
          <ul class="menu-list">
              <li><a href="http://engineering.pivotal.io/">
                <span class="icon is-small"><i class="fa fa-globe fa-fw"></i></span>
                <span class="link-text">Pivotal Engineering Journal</span>
              </a></li>
              <li><a href="http://blog.cleancoder.com/">
                <span class="icon is-small"><i class="fa fa-globe fa-fw"></i></span>
                <span class="link-text">The Clean Code Blog</span>
              </a></li>
              <li><a href="https://codeascraft.com/">
                <span class="icon is-small"><i class="fa fa-globe fa-fw"></i></span>
                <span class="link-text">Code as Craft</span>
              </a></li>
              <li><a href="http://corgibytes.com/blog/">
                <span class="icon is-small"><i class="fa fa-globe fa-fw"></i></span>
                <span class="link-text">Corgibytes Blog</span>
              </a></li>
          </ul>
<p class="menu-label">Social</p>
<ul class="menu-list">
    <li><a href="https://github.com/textbook">
      <span class="icon is-small">
          <i class="fa fa-github fa-fw"></i>
      </span>
      <span class="link-text">GitHub</span>
    </a></li>
    <li><a href="http://stackoverflow.com/users/3001761/jonrsharpe">
      <span class="icon is-small">
          <i class="fa fa-stack-overflow fa-fw"></i>
      </span>
      <span class="link-text">Stack Overflow</span>
    </a></li>
    <li><a href="https://twitter.com/jonrsharpe">
      <span class="icon is-small">
          <i class="fa fa-twitter fa-fw"></i>
      </span>
      <span class="link-text">Twitter</span>
    </a></li>
    <li><a href="https://500px.com/jonrsharpe">
      <span class="icon is-small">
          <i class="fa fa-500px fa-fw"></i>
      </span>
      <span class="link-text">500px</span>
    </a></li>

    <li><a href="https://blog.jonrshar.pe/feeds/all.atom.xml"
           type="application/atom+xml" rel="alternate">
      <span class="icon is-small"><i class="fa fa-rss"></i></span>
      <span class="link-text">Atom Feed</span>
    </a></li>

</ul>          <p class="menu-label">License</p>
          
<ul class="menu-list">
  <li>
    <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
      <span class="icon is-small">
        <i class="fa fa-creative-commons fa-fw"></i>
      </span>
      <span>CC BY-SA 4.0</span>
    </a>
  </li>
</ul>

      </aside>
    </div>
  </div>
</div>

<footer class="footer">
  <div class="container has-text-centered">
 <p class="subtitle">These are my opinions - if you don't like them, I have others</p>    <div class="credits">
      <span><a href="https://github.com/textbook/bulrush">Bulrush</a> theme for
        <a href="https://blog.getpelican.com/">Pelican</a></span>
      <span><span class="icon is-small"><i class="fa fa-html5"></i></span> HTML 5</span>
      <span><span class="icon is-small"><i class="fa fa-css3"></i></span> CSS 3</span>
      <span>Made with <a href="https://bulma.io">Bulma</a></span>
    </div>
  </div>
  <div class="github-fork-ribbon-wrapper is-hidden-mobile is-hidden-print">
    <div class="github-fork-ribbon">
      <a href="https://github.com/textbook/textbook.github.io">
        <i class="fa fa-github fa-fw"></i>
        Fork me on GitHub
      </a>
    </div>
  </div>
</footer>

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-64837080-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = 'https://ssl.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'textbook-dev';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<script type="text/javascript">
  document.getElementById('navToggle').addEventListener('click', function () {
    var nav = document.getElementById('navMenu');
    var className = nav.getAttribute('class');
    if (className == 'navbar-menu') {
      nav.className = 'navbar-menu is-active';
    } else {
      nav.className = 'navbar-menu';
    }
  });
</script>
</body>
</html>