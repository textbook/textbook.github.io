<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width">
  <title>JS TDD Vite</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://blog.jonrshar.pe/theme/css/main.3dad1b7a.css">
  <style media="print">.is-hidden-print{display:none !important}</style>
      <link rel="stylesheet" href="https://blog.jonrshar.pe/custom.css">
<meta property="og:title" content="textbook - JS TDD Vite">
  <meta property="og:description" content="Test-driven JavaScript development done right - supplement A">
<meta property="og:url" content="https://blog.jonrshar.pe/2023/Dec/17/js-tdd-vite.html">
    <meta property="og:image" content="https://blog.jonrshar.pe/images/avatar.png">
    <meta name="twitter:image:alt" content="textbook | These are my opinions - if you don't like them, I have others">
<meta name="twitter:card" content="summary">
  <meta name="twitter:creator" content="@jonrsharpe">
  <meta name="twitter:site" content="@jonrsharpe">
<meta property="og:site_name" content="textbook">
<meta property="og:type" content="article">
  <meta property="article:published_time" content="2023-12-17T11:30:00+00:00">
  <meta property="article:modified_time" content="2024-01-04T16:15:00+00:00">
    <meta property="article:tag" content="javascript">
    <meta property="article:tag" content="tdd">
    <meta property="article:tag" content="xp">
  <meta property="article:section" content="development">
</head>

<body id="index" class="home">
<header class="hero is-primary">
  <div class="hero-head">
    <div class="container">
      <nav class="navbar">
        <div class="navbar-brand">
          <a class="navbar-item title is-3"
             href="https://blog.jonrshar.pe/">textbook</a>
        </div>
      </nav>
    </div>
  </div>
</header>

<nav class="navbar has-shadow is-hidden-print">
  <div class="container">
    <div class="navbar-center"></div>
    <span id="navToggle" class="navbar-burger">
      <span></span>
      <span></span>
      <span></span>
    </span>
    <div id="navMenu" class="navbar-menu">
        <div class="navbar-end">
              <a class="navbar-item is-tab "
                 href="https://blog.jonrshar.pe/category/work.html">work</a>
              <a class="navbar-item is-tab "
                 href="https://blog.jonrshar.pe/category/meta.html">meta</a>
              <a class="navbar-item is-tab is-active"
                 href="https://blog.jonrshar.pe/category/development.html">development</a>
        </div>
    </div>
  </div>
</nav>

<div class="container">
  <div class="section columns">
    <div class="column is-three-quarters-desktop is-two-thirds-tablet">
<section id="content" class="body">
  <article>
    <h1 class="title">
      <a href="https://blog.jonrshar.pe/2023/Dec/17/js-tdd-vite.html" rel="bookmark"
         title="Permalink to JS TDD Vite">JS TDD Vite</a></h1>
<footer class="post-info">
  <abbr class="published" title="2023-12-17T11:30:00+00:00">
    Published <span class="is-info">Sun 17 December 2023</span>
    in <a href="https://blog.jonrshar.pe/category/development.html">development</a>
  </abbr>
    <br />
    <abbr class="modified" title="2024-01-04T16:15:00+00:00">
      Updated Thu 04 January 2024
    </abbr>

    <p class="author">
      <em>by           Jonathan Sharpe
</em>
      <span class="tag is-small is-rounded">
        <a href="https://blog.jonrshar.pe/tag/javascript.html">javascript</a>
      </span>
      <span class="tag is-small is-rounded">
        <a href="https://blog.jonrshar.pe/tag/tdd.html">tdd</a>
      </span>
      <span class="tag is-small is-rounded">
        <a href="https://blog.jonrshar.pe/tag/xp.html">xp</a>
      </span>
    </p>
  
</footer>    <div class="section"><p>Since I wrote some of the earlier parts of this series (see <a href="https://blog.jonrshar.pe/2020/Nov/22/js-tdd-e2e.html">part 2</a> and
<a href="https://blog.jonrshar.pe/2021/Apr/10/js-tdd-api.html">part 3</a>), <a href="https://create-react-app.dev/">Create React App</a> has become a little stale. As of right
now, a brand new app shows multiple known vulnerabilities on installation:</p>
<div class="highlight"><pre><span></span><code><span class="mf">8</span><span class="w"> </span><span class="n">vulnerabilities</span><span class="w"> </span><span class="p">(</span><span class="mf">2</span><span class="w"> </span><span class="n">moderate</span><span class="p">,</span><span class="w"> </span><span class="mf">6</span><span class="w"> </span><span class="n">high</span><span class="p">)</span>

<span class="kr">To</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">issues</span><span class="w"> </span><span class="p">(</span><span class="n">including</span><span class="w"> </span><span class="n">breaking</span><span class="w"> </span><span class="n">changes</span><span class="p">),</span><span class="w"> </span><span class="kr">run</span><span class="p">:</span>
<span class="w">  </span><span class="n">npm</span><span class="w"> </span><span class="n">audit</span><span class="w"> </span><span class="n">fix</span><span class="w"> </span><span class="o">--</span><span class="kr">for</span><span class="n">ce</span>

<span class="kr">Run</span><span class="w"> </span><span class="err">`</span><span class="n">npm</span><span class="w"> </span><span class="n">audit</span><span class="err">`</span><span class="w"> </span><span class="kr">for</span><span class="w"> </span><span class="n">details</span><span class="mf">.</span>
</code></pre></div>

<p>(this <a href="https://github.com/facebook/create-react-app/issues/11174">isn't necessarily the problem</a> it might appear, but
likely wouldn't happen at all if the dependencies were kept up-to-date) and a
warning of imminent breakage on build (spelling error in original):</p>
<div class="highlight"><pre><span></span><code><span class="n">One</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">dependencies</span><span class="p">,</span><span class="w"> </span><span class="n">babel</span><span class="o">-</span><span class="n">preset</span><span class="o">-</span><span class="n">react</span><span class="o">-</span><span class="n">app</span><span class="p">,</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">importing</span><span class="w"> </span><span class="n">the</span>
<span class="ss">&quot;@babel/plugin-proposal-private-property-in-object&quot;</span><span class="w"> </span><span class="n">package</span><span class="w"> </span><span class="k">without</span>
<span class="n">declaring</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">dependencies</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">currently</span><span class="w"> </span><span class="n">working</span><span class="w"> </span><span class="n">because</span>
<span class="ss">&quot;@babel/plugin-proposal-private-property-in-object&quot;</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">your</span>
<span class="n">node_modules</span><span class="w"> </span><span class="n">folder</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">unrelated</span><span class="w"> </span><span class="n">reasons</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="nc">time</span><span class="p">.</span>

<span class="n">babel</span><span class="o">-</span><span class="n">preset</span><span class="o">-</span><span class="n">react</span><span class="o">-</span><span class="n">app</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">part</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">create</span><span class="o">-</span><span class="n">react</span><span class="o">-</span><span class="n">app</span><span class="w"> </span><span class="n">project</span><span class="p">,</span><span class="w"> </span><span class="n">which</span>
<span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">maintianed</span><span class="w"> </span><span class="n">anymore</span><span class="p">.</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">thus</span><span class="w"> </span><span class="n">unlikely</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">bug</span><span class="w"> </span><span class="n">will</span>
<span class="n">ever</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">fixed</span><span class="p">.</span><span class="w"> </span><span class="k">Add</span><span class="w"> </span><span class="ss">&quot;@babel/plugin-proposal-private-property-in-object&quot;</span><span class="w"> </span><span class="k">to</span>
<span class="n">your</span><span class="w"> </span><span class="n">devDependencies</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">work</span><span class="w"> </span><span class="n">around</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">message</span>
<span class="k">go</span><span class="w"> </span><span class="n">away</span><span class="p">.</span>
</code></pre></div>

<p>(this is trivially fixable in your generated app, but has been known about
for a while and still hasn't been fixed in CRA itself). The last available
release, v5.0.1, dates back to April 12th, 2022 (~18 months ago and counting).
The <a href="https://react.dev/">new React docs</a> don't even mention CRA. In this context, it
might be time to think about moving away from CRA for new projects.</p>
<p>Probably the closest thing to a drop-in equivalent of CRA right now, in terms
of offering an opinionated client-side app setup, is <a href="https://vitejs.dev/">Vite</a>. So I thought I'd
provide a quick update to show how to get a React app ready for TDD on Vite.</p>
<p><strong>Note</strong> that if a pure client-side/"single page" app doesn't meet your needs,
there are some recommendations for more complex projects in the official React
docs <a href="https://react.dev/learn/start-a-new-react-project">here</a>.</p>
<h2 id="part-1">Scaffolding the app [1/5]</h2>
<p>Create a new npm package with the Vite React structure using the following
command (you can use the <code>react</code> or <code>react-swc</code> templates - there are also
equivalents with TypeScript pre-configured if you like):</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>create<span class="w"> </span>vite@latest<span class="w"> </span>test-driven-vite<span class="w"> </span>--<span class="w"> </span>--template<span class="w"> </span>react
Need<span class="w"> </span>to<span class="w"> </span>install<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>packages:
create-vite@5.1.0
Ok<span class="w"> </span>to<span class="w"> </span>proceed?<span class="w"> </span><span class="o">(</span>y<span class="o">)</span><span class="w"> </span>y

Scaffolding<span class="w"> </span>project<span class="w"> </span><span class="k">in</span><span class="w"> </span>path/to/test-driven-vite...

Done.<span class="w"> </span>Now<span class="w"> </span>run:

<span class="w">  </span><span class="nb">cd</span><span class="w"> </span>test-driven-vite
<span class="w">  </span>npm<span class="w"> </span>install
<span class="w">  </span>npm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>

<p>Follow the instructions it gave you:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>test-driven-vite
$<span class="w"> </span>npm<span class="w"> </span>install

added<span class="w"> </span><span class="m">270</span><span class="w"> </span>packages,<span class="w"> </span>and<span class="w"> </span>audited<span class="w"> </span><span class="m">271</span><span class="w"> </span>packages<span class="w"> </span><span class="k">in</span><span class="w"> </span>35s

<span class="m">97</span><span class="w"> </span>packages<span class="w"> </span>are<span class="w"> </span>looking<span class="w"> </span><span class="k">for</span><span class="w"> </span>funding
<span class="w">  </span>run<span class="w"> </span><span class="sb">`</span>npm<span class="w"> </span>fund<span class="sb">`</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>details

found<span class="w"> </span><span class="m">0</span><span class="w"> </span>vulnerabilities
$<span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>dev

&gt;<span class="w"> </span>test-driven-vite@0.0.0<span class="w"> </span>dev
&gt;<span class="w"> </span>vite


<span class="w">  </span>VITE<span class="w"> </span>v5.0.10<span class="w">  </span>ready<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">5289</span><span class="w"> </span>ms

<span class="w">  </span>➜<span class="w">  </span>Local:<span class="w">   </span>http://localhost:5173/
<span class="w">  </span>➜<span class="w">  </span>Network:<span class="w"> </span>use<span class="w"> </span>--host<span class="w"> </span>to<span class="w"> </span>expose
<span class="w">  </span>➜<span class="w">  </span>press<span class="w"> </span>h<span class="w"> </span>+<span class="w"> </span>enter<span class="w"> </span>to<span class="w"> </span>show<span class="w"> </span><span class="nb">help</span>
</code></pre></div>

<p>This is roughly equivalent to scaffolding a new CRA app and running <code>npm
start</code>; you should be able to visit the URL and see a basic app page. However,
there are a couple of things CRA did for us that <code>create-vite</code> doesn't, so
we'll need a few extra steps before we can start test-driving any real
functionality.</p>
<h2 id="part-2">Creating a git repo [2/5]</h2>
<p>Although the template does include a <code>.gitignore</code> file, a git repository is
not created by default. If you try checking the status, you can see the
directory doesn't contain one:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>status
fatal:<span class="w"> </span>not<span class="w"> </span>a<span class="w"> </span>git<span class="w"> </span>repository<span class="w"> </span><span class="o">(</span>or<span class="w"> </span>any<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>parent<span class="w"> </span>directories<span class="o">)</span>:<span class="w"> </span>.git
</code></pre></div>

<p>So let's create a fresh git repo, as we did back in <a href="https://blog.jonrshar.pe/2020/Aug/31/js-tdd-ftw.html">part 1</a>, then commit the
files <code>create-vite</code> added for us:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>init
Reinitialized<span class="w"> </span>existing<span class="w"> </span>Git<span class="w"> </span>repository<span class="w"> </span><span class="k">in</span><span class="w"> </span>path/to/test-driven-vite/.git/
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>--allow-empty<span class="w"> </span>--message<span class="w"> </span><span class="s1">&#39;Initial commit&#39;</span>
<span class="o">[</span>main<span class="w"> </span><span class="o">(</span>root-commit<span class="o">)</span><span class="w"> </span>cf3ac9f<span class="o">]</span><span class="w"> </span>Initial<span class="w"> </span>commit
$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>--message<span class="w"> </span><span class="s1">&#39;Create Vite app&#39;</span>
<span class="o">[</span>main<span class="w"> </span>f9ab178<span class="o">]</span><span class="w"> </span>Create<span class="w"> </span>Vite<span class="w"> </span>app
<span class="w"> </span><span class="m">13</span><span class="w"> </span>files<span class="w"> </span>changed,<span class="w"> </span><span class="m">4264</span><span class="w"> </span>insertions<span class="o">(</span>+<span class="o">)</span>
<span class="w"> </span>create<span class="w"> </span>mode<span class="w"> </span><span class="m">100644</span><span class="w"> </span>.eslintrc.cjs
<span class="w"> </span><span class="c1"># ... other files created</span>
<span class="w"> </span>create<span class="w"> </span>mode<span class="w"> </span><span class="m">100644</span><span class="w"> </span>vite.config.js
</code></pre></div>

<p>Now all of our changes are safely under version control.</p>
<h2 id="part-3">Setting up testing [3/5]</h2>
<p>Another thing CRA included by default was a test, run with <a href="https://jestjs.io/">Jest</a> and using
<a href="https://testing-library.com/docs/react-testing-library/intro">React Testing Library</a> to render and select elements. However, we can see
that a new Vite app includes no test script at all:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>t
npm<span class="w"> </span>ERR!<span class="w"> </span>Missing<span class="w"> </span>script:<span class="w"> </span><span class="s2">&quot;test&quot;</span>
npm<span class="w"> </span>ERR!
npm<span class="w"> </span>ERR!<span class="w"> </span>To<span class="w"> </span>see<span class="w"> </span>a<span class="w"> </span>list<span class="w"> </span>of<span class="w"> </span>scripts,<span class="w"> </span>run:
npm<span class="w"> </span>ERR!<span class="w">   </span>npm<span class="w"> </span>run

npm<span class="w"> </span>ERR!<span class="w"> </span>A<span class="w"> </span><span class="nb">complete</span><span class="w"> </span>log<span class="w"> </span>of<span class="w"> </span>this<span class="w"> </span>run<span class="w"> </span>can<span class="w"> </span>be<span class="w"> </span>found<span class="w"> </span><span class="k">in</span>:<span class="w"> </span>path/to/something.log
</code></pre></div>

<p>As an alternative to Jest, there's <a href="https://vitest.dev/">Vitest</a>. This test runner uses the same
build tooling as Vite, and has API compatibility with Jest (so everything you
learned about <code>it</code>, <code>expect</code>, etc. still applies).</p>
<p>So let's install this, as well as JSDOM (which allows the components to be
rendered outside of a real browser environment - this was installed as part
of <code>jest-environment-jsdom</code> by CRA) and the same Testing Library utilities
we've used previously.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>install<span class="w"> </span>--save-dev<span class="w"> </span>@testing-library/<span class="o">{</span>jest-dom,react,user-event<span class="o">}</span><span class="w"> </span>jsdom<span class="w"> </span>vitest

added<span class="w"> </span><span class="m">129</span><span class="w"> </span>packages,<span class="w"> </span>and<span class="w"> </span>audited<span class="w"> </span><span class="m">400</span><span class="w"> </span>packages<span class="w"> </span><span class="k">in</span><span class="w"> </span>1s

<span class="m">124</span><span class="w"> </span>packages<span class="w"> </span>are<span class="w"> </span>looking<span class="w"> </span><span class="k">for</span><span class="w"> </span>funding
<span class="w">  </span>run<span class="w"> </span><span class="sb">`</span>npm<span class="w"> </span>fund<span class="sb">`</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>details

found<span class="w"> </span><span class="m">0</span><span class="w"> </span>vulnerabilities
</code></pre></div>

<p>We need a little bit of additional configuration in <code>vite.config.js</code>:</p>
<div class="highlight"><pre><span></span><code><span class="w"> </span>export default defineConfig({
<span class="w"> </span>  plugins: [react()],
<span class="gi">+  test: {</span>
<span class="gi">+    environment: &#39;jsdom&#39;,</span>
<span class="gi">+    globals: true,</span>
<span class="gi">+    setupFiles: [</span>
<span class="gi">+      &#39;@testing-library/jest-dom&#39;,</span>
<span class="gi">+    ],</span>
<span class="gi">+  },</span>
<span class="w"> </span>})
</code></pre></div>

<p>This will:</p>
<ol>
<li>Use the JSDOM test environment, to allow browser-based code to work;</li>
<li>Inject some global functions (e.g. <code>describe</code> and <code>it</code>) into the tests, as
   Jest does; and</li>
<li>Load Testing Library's <a href="https://testing-library.com/docs/ecosystem-jest-dom/">Jest-DOM</a> selectors (like <code>.toHaveAttribute</code>), so we
   can make assertions on the rendered elements.</li>
</ol>
<p><strong>Note</strong> instead of using JSDOM (or <a href="https://www.npmjs.com/package/happy-dom">Happy DOM</a>, which
Vitest also supports) to provide a mock browser environment, you could try
Vitest's <a href="https://vitest.dev/guide/browser.html">experimental browser mode</a> to run the tests
in an actual browser. Here we'll stick with JSDOM for consistency with what
we had in CRA.</p>
<p>Finally, let's tell npm we want to use Vitest to run our tests:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>pkg<span class="w"> </span><span class="nb">set</span><span class="w"> </span>scripts.test<span class="o">=</span><span class="s1">&#39;vitest&#39;</span>
</code></pre></div>

<p>Like Jest, Vitest will fail if you try to run it when there are no actual tests:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>npm<span class="w"> </span>t

&gt;<span class="w"> </span>test-driven-vite@0.0.0<span class="w"> </span><span class="nb">test</span>
&gt;<span class="w"> </span>vitest


<span class="w"> </span>DEV<span class="w">  </span>v1.0.4<span class="w"> </span>path/to/test-driven-vite

include:<span class="w"> </span>**/*.<span class="o">{</span>test,spec<span class="o">}</span>.?<span class="o">(</span>c<span class="p">|</span>m<span class="o">)[</span>jt<span class="o">]</span>s?<span class="o">(</span>x<span class="o">)</span>
exclude:<span class="w">  </span>**/node_modules/**,<span class="w"> </span>**/dist/**,<span class="w"> </span>**/cypress/**,<span class="w"> </span>**/.<span class="o">{</span>idea,git,cache,output,temp<span class="o">}</span>/**,<span class="w"> </span>**/<span class="o">{</span>karma,rollup,webpack,vite,vitest,jest,ava,babel,nyc,cypress,tsup,build,eslint,prettier<span class="o">}</span>.config.*
watch<span class="w"> </span>exclude:<span class="w">  </span>**/node_modules/**,<span class="w"> </span>**/dist/**

No<span class="w"> </span><span class="nb">test</span><span class="w"> </span>files<span class="w"> </span>found,<span class="w"> </span>exiting<span class="w"> </span>with<span class="w"> </span>code<span class="w"> </span><span class="m">1</span>
</code></pre></div>

<h2 id="part-4">Writing a test [4/5]</h2>
<p>So let's create one, in <code>src/App.spec.jsx</code>. Pick some aspect of the page
that gets rendered (in this case I've chosen the main heading that's shown) and
write a simple test for it:</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">render</span><span class="p">,</span><span class="w"> </span><span class="nx">screen</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@testing-library/react&#39;</span>

<span class="k">import</span><span class="w"> </span><span class="nx">App</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./App.jsx&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;App&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;renders a top-level heading&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">render</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">App</span><span class="w"> </span><span class="o">/&gt;</span><span class="p">)</span>

<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">screen</span><span class="p">.</span><span class="nx">getByRole</span><span class="p">(</span><span class="s1">&#39;heading&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">})).</span><span class="nx">toHaveTextContent</span><span class="p">(</span><span class="s1">&#39;Vite + React&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>

<p>As you can see, this looks identical to the sort of thing we had in Jest.
When we run it, it should pass:</p>
<div class="highlight"><pre><span></span><code>$<span class="w">  </span>npm<span class="w"> </span><span class="nb">test</span>

&gt;<span class="w"> </span>test-driven-vite@0.0.0<span class="w"> </span><span class="nb">test</span>
&gt;<span class="w"> </span>vitest


<span class="w"> </span>DEV<span class="w">  </span>v1.0.4<span class="w"> </span>path/to/test-driven-vite

<span class="w"> </span>✓<span class="w"> </span>src/App.spec.jsx<span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="o">)</span>
<span class="w">   </span>✓<span class="w"> </span>App<span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="o">)</span>
<span class="w">     </span>✓<span class="w"> </span>renders<span class="w"> </span>a<span class="w"> </span>top-level<span class="w"> </span>heading

<span class="w"> </span>Test<span class="w"> </span>Files<span class="w">  </span><span class="m">1</span><span class="w"> </span>passed<span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="o">)</span>
<span class="w">      </span>Tests<span class="w">  </span><span class="m">1</span><span class="w"> </span>passed<span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="o">)</span>
<span class="w">   </span>Start<span class="w"> </span>at<span class="w">  </span><span class="m">00</span>:09:12
<span class="w">   </span>Duration<span class="w">  </span>664ms<span class="w"> </span><span class="o">(</span>transform<span class="w"> </span>30ms,<span class="w"> </span>setup<span class="w"> </span>89ms,<span class="w"> </span>collect<span class="w"> </span>85ms,<span class="w"> </span>tests<span class="w"> </span>41ms,<span class="w"> </span>environment<span class="w"> </span>277ms,<span class="w"> </span>prepare<span class="w"> </span>63ms<span class="o">)</span>


<span class="w"> </span>PASS<span class="w">  </span>Waiting<span class="w"> </span><span class="k">for</span><span class="w"> </span>file<span class="w"> </span>changes...
<span class="w">       </span>press<span class="w"> </span>h<span class="w"> </span>to<span class="w"> </span>show<span class="w"> </span>help,<span class="w"> </span>press<span class="w"> </span>q<span class="w"> </span>to<span class="w"> </span>quit
</code></pre></div>

<p><strong>Note</strong> that like the default CRA Jest setup, Vitest enters a watch mode by
default. To run the tests once then stop, use <code>npm test -- --run</code>.</p>
<p>Quit the test runner when you're satisfied everything is working, then commit
the changes:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
$<span class="w"> </span>git<span class="w"> </span>status
On<span class="w"> </span>branch<span class="w"> </span>main
Changes<span class="w"> </span>to<span class="w"> </span>be<span class="w"> </span>committed:
<span class="w">  </span><span class="o">(</span>use<span class="w"> </span><span class="s2">&quot;git restore --staged &lt;file&gt;...&quot;</span><span class="w"> </span>to<span class="w"> </span>unstage<span class="o">)</span>
<span class="w">        </span>modified:<span class="w">   </span>package-lock.json
<span class="w">        </span>modified:<span class="w">   </span>package.json
<span class="w">        </span>new<span class="w"> </span>file:<span class="w">   </span>src/App.spec.jsx
<span class="w">        </span>modified:<span class="w">   </span>vite.config.js

$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>--message<span class="w"> </span><span class="s1">&#39;Add a simple test&#39;</span>
<span class="o">[</span>main<span class="w"> </span>2431a65<span class="o">]</span><span class="w"> </span>Add<span class="w"> </span>a<span class="w"> </span>simple<span class="w"> </span><span class="nb">test</span>
<span class="w"> </span><span class="m">4</span><span class="w"> </span>files<span class="w"> </span>changed,<span class="w"> </span><span class="m">1619</span><span class="w"> </span>insertions<span class="o">(</span>+<span class="o">)</span>,<span class="w"> </span><span class="m">51</span><span class="w"> </span>deletions<span class="o">(</span>-<span class="o">)</span>
<span class="w"> </span>create<span class="w"> </span>mode<span class="w"> </span><span class="m">100644</span><span class="w"> </span>src/App.spec.jsx
</code></pre></div>

<h2 id="part-5">Exercises [5/5]</h2>
<p>This was just a supplement, so the exercise is pretty simple: redo an earlier
exercise in the series, using Vite/Vitest instead of CRA/Jest.</p>
<p><strong>Note</strong> that you can set up Cypress exactly as you did before - the
end-to-end tests don't care what (if any) library or framework you're using
to create the page. If you follow the guide from <a href="https://blog.jonrshar.pe/2021/Apr/10/js-tdd-api.html">part 3</a> on creating the
<code>e2e:ci</code> <em>"automatic E2E"</em>, you don't need to install <code>serve</code> to test the
app in production mode; <code>vite preview</code> already does this:</p>
<div class="highlight"><pre><span></span><code>{
<span class="w">  </span><span class="o">//</span><span class="w"> </span>...
<span class="w">  </span><span class="s2">&quot;scripts&quot;</span>:<span class="w"> </span>{
<span class="w">    </span><span class="o">//</span><span class="w"> </span>...
<span class="w">    </span><span class="s2">&quot;e2e:ci&quot;</span>:<span class="w"> </span><span class="s2">&quot;concurrently --kill-others --success first \&quot;</span><span class="nv">npm</span>:<span class="nv">e2e</span>:<span class="nv">ci</span>:<span class="o">*</span>\<span class="s2">&quot;&quot;</span>,
<span class="w">    </span><span class="s2">&quot;pree2e:ci:app&quot;</span>:<span class="w"> </span><span class="s2">&quot;npm run build&quot;</span>,
<span class="w">    </span><span class="s2">&quot;e2e:ci:app&quot;</span>:<span class="w"> </span><span class="s2">&quot;npm run preview&quot;</span>,
<span class="w">    </span><span class="s2">&quot;pree2e:ci:run&quot;</span>:<span class="w"> </span><span class="s2">&quot;wait-on --log --timeout 60000 http-get://localhost:4173&quot;</span>,
<span class="w">    </span><span class="s2">&quot;e2e:ci:run&quot;</span>:<span class="w"> </span><span class="s2">&quot;cross-env CYPRESS_BASE_URL=http://localhost:4173 npm run e2e&quot;</span>,
<span class="w">    </span><span class="o">//</span><span class="w"> </span>...
<span class="w">  </span>},
<span class="w">  </span><span class="o">//</span><span class="w"> </span>...
}
</code></pre></div>

<h2 id="bonus">To global, or not to global? [Bonus]</h2>
<p>By default, Vitest does <strong>not</strong> inject anything into the global scope. To keep
things as similar to Jest as possible, we've overridden this with
<code>globals: true</code> above. Alternatively you could choose the more explicit option,
and omit <code>globals: true</code> (or explicitly set <code>globals: false</code>) in the
configuration. But if you do that, you'll need to make some other adjustments:</p>
<ol>
<li>
<p>Firstly, and most obviously, every test file will have to explicitly
   import the functions it needs for defining suites, tests and expectations:</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">describe</span><span class="p">,</span><span class="w"> </span><span class="nx">expect</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vitest&#39;</span>
</code></pre></div>

</li>
<li>
<p>Secondly, the default entrypoint for <code>@testing-library/jest-dom</code> that we
    used in <code>setupFiles</code> assumes that <code>expect</code> will be provided globally. Now
    that it won't be, we have to switch to the Vitest-specific entrypoint
    <code>@testing-library/jest-dom/vitest</code>, which includes an explicit:</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="nx">expect</span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vitest&#39;</span>
</code></pre></div>

<p>before extending <code>expect</code> with its own matchers.</p>
</li>
<li>
<p>Finally, React Testing Library's <a href="https://testing-library.com/docs/react-testing-library/api#cleanup">automatic application of
    <code>cleanup</code></a> only occurs if there's a globally-provided
    <code>afterEach</code> function for it to hook into. This is explicitly called out in
    the <a href="https://vitest.dev/guide/migration.html#globals-as-a-default">Vitest migration guide</a>:</p>
<blockquote>
<p>If you decide to keep globals disabled, be aware that common libraries
like <code>testing-library</code> will not run auto DOM cleanup.</p>
</blockquote>
<p>Without this, each test is adding more and more elements into the render
result, which means your tests can interfere with each other (most likely
with error messages about matching more than one element when only one is
expected, but even worse a test could incorrectly <em>pass</em> due to something
that was rendered by a previous one still hanging around).</p>
</li>
</ol>
<p>We can deal with 2 and 3 simultaneously by changing the configuration to:</p>
<div class="highlight"><pre><span></span><code><span class="w"> </span>  plugins: [react()],
<span class="w"> </span>  test: {
<span class="w"> </span>    environment: &#39;jsdom&#39;,
<span class="gd">-    globals: true,</span>
<span class="w"> </span>    setupFiles: [
<span class="gd">-      &#39;@testing-library/jest-dom&#39;,</span>
<span class="gi">+      &#39;./src/setupTests.js&#39;,</span>
<span class="w"> </span>    ],
<span class="w"> </span>  },
<span class="w"> </span>})
</code></pre></div>

<p>and creating the corresponding <code>src/setupTests.js</code> file containing:</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="s1">&#39;@testing-library/jest-dom/vitest&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">cleanup</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@testing-library/react&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">afterEach</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vitest&#39;</span>

<span class="nx">afterEach</span><span class="p">(</span><span class="nx">cleanup</span><span class="p">)</span>
</code></pre></div></div>
    <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'textbook-dev';
        var disqus_identifier = '2023/Dec/17/js-tdd-vite.html';
        var disqus_url = 'https://blog.jonrshar.pe/2023/Dec/17/js-tdd-vite.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//textbook-dev.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>

  </article>
</section>

<script type="application/ld+json">
  {"articleSection": "development", "author": {"@type": "Person", "name": "Jonathan Sharpe"}, "datePublished": "2023-12-17T11:30:00+00:00", "headline": "JS TDD Vite", "mainEntityOfPage": {"@type": "WebPage", "@id": "https://blog.jonrshar.pe/2023/Dec/17/js-tdd-vite.html"}, "@context": "http://schema.org", "@type": "BlogPosting", "dateModified": "2024-01-04T16:15:00+00:00", "description": "Test-driven JavaScript development done right - supplement A"}
</script>
    </div>

    <div class="column is-one-quarter-desktop is-one-third-tablet is-hidden-print">
      <aside class="menu">
<div id="mc_embed_signup">
  <form
      action="https://jonrshar.us15.list-manage.com/subscribe/post?u=7ada11180797f3af73228bf0b&amp;id=d172abcbd2"
      method="post" id="mc-embedded-subscribe-form"
      name="mc-embedded-subscribe-form" class="validate" target="_blank"
      novalidate>

    <h2 class="menu-label">Mailing List</h2>

    <div id="mc_embed_signup_scroll">
      <div class="field mc-field-group">
        <label for="mce-EMAIL" class="label is-small">Email</label>
        <div class="field-body">
          <div class="field">
            <p class="control has-icons-left">
              <input type="email" name="EMAIL" class="input required email is-small"
                     id="mce-EMAIL" placeholder="Email address">
              <span class="icon is-small is-left">
              <i class="fa fa-envelope"></i>
            </span>
            </p>
          </div>
        </div>
      </div>
      <div class="field">
        <label for="mce-FNAME" class="label is-small">Name</label>
        <div class="field-body">
          <div class="field is-grouped">
            <p class="control is-expanded">
              <input class="input is-small" type="text" value="" name="FNAME"
                     id="mce-FNAME" placeholder="First">
            </p>
            <p class="control is-expanded">
              <input class="input is-small" type="text" value="" name="LNAME"
                     id="mce-LNAME" placeholder="Last">
            </p>
          </div>
        </div>
      </div>
      <div class="field is-grouped">
        <p class="control">
          <input type="submit" name="subscribe" value="Subscribe"
                 class="button is-small is-success" id="mc-embedded-subscribe">
        </p>
          <p class="control">
            <span class="help">
              Powered by
              <a href="http://eepurl.com/cNv6Rb"
                 title="MailChimp - email marketing made easy and fun">
                MailChimp
              </a>
            </span>
          </p>
      </div>

      <div id="mce-responses" class="clear">
        <div class="response help is-danger" id="mce-error-response"
             style="display:none"></div>
        <div class="response help is-success" id="mce-success-response"
             style="display:none"></div>
      </div>

      <div style="position: absolute; left: -5000px;" aria-hidden="true">
        <input type="text" name="b_7ada11180797f3af73228bf0b_d172abcbd2"
               tabindex="-1" value="">
      </div>
    </div>
  </form>
</div>

          <p class="menu-label">Other Pages</p>
          <ul class="menu-list">
                <li><a                        href="https://blog.jonrshar.pe/pages/about.html">
                  <span class="icon is-small"><i class="fa fa-book"></i></span>
                  <span class="link-text">About</span>
                </a></li>
          </ul>
          <p class="menu-label">Links</p>
          <ul class="menu-list">
              <li><a href="http://engineering.pivotal.io/">
                <span class="icon is-small"><i class="fa fa-globe fa-fw"></i></span>
                <span class="link-text">Pivotal Engineering Journal</span>
              </a></li>
              <li><a href="http://blog.cleancoder.com/">
                <span class="icon is-small"><i class="fa fa-globe fa-fw"></i></span>
                <span class="link-text">The Clean Code Blog</span>
              </a></li>
              <li><a href="https://codeascraft.com/">
                <span class="icon is-small"><i class="fa fa-globe fa-fw"></i></span>
                <span class="link-text">Code as Craft</span>
              </a></li>
              <li><a href="http://corgibytes.com/blog/">
                <span class="icon is-small"><i class="fa fa-globe fa-fw"></i></span>
                <span class="link-text">Corgibytes Blog</span>
              </a></li>
          </ul>
<p class="menu-label">Social</p>
<ul class="menu-list">
    <li><a href="https://github.com/textbook">
      <span class="icon is-small">
          <i class="fa fa-github fa-fw"></i>
      </span>
      <span class="link-text">GitHub</span>
    </a></li>
    <li><a href="http://stackoverflow.com/users/3001761/jonrsharpe">
      <span class="icon is-small">
          <i class="fa fa-stack-overflow fa-fw"></i>
      </span>
      <span class="link-text">Stack Overflow</span>
    </a></li>
    <li><a href="https://twitter.com/jonrsharpe">
      <span class="icon is-small">
          <i class="fa fa-twitter fa-fw"></i>
      </span>
      <span class="link-text">Twitter</span>
    </a></li>
    <li><a href="https://500px.com/jonrsharpe">
      <span class="icon is-small">
          <i class="fa fa-500px fa-fw"></i>
      </span>
      <span class="link-text">500px</span>
    </a></li>

    <li><a href="https://blog.jonrshar.pe/feeds/all.atom.xml"
           type="application/atom+xml" rel="alternate">
      <span class="icon is-small"><i class="fa fa-rss"></i></span>
      <span class="link-text">Atom Feed</span>
    </a></li>

</ul>          <p class="menu-label">License</p>
          
<ul class="menu-list">
  <li>
    <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
      <span class="icon is-small">
        <i class="fa fa-creative-commons fa-fw"></i>
      </span>
      <span>CC BY-SA 4.0</span>
    </a>
  </li>
</ul>

      </aside>
    </div>
  </div>
</div>

<footer class="footer">
  <div class="container has-text-centered">
 <p class="subtitle">These are my opinions - if you don't like them, I have others</p>    <div class="credits">
      <span><a href="https://github.com/textbook/bulrush">Bulrush</a> theme for
        <a href="https://blog.getpelican.com/">Pelican</a></span>
      <span><span class="icon is-small"><i class="fa fa-html5"></i></span> HTML 5</span>
      <span><span class="icon is-small"><i class="fa fa-css3"></i></span> CSS 3</span>
      <span>Made with <a href="https://bulma.io">Bulma</a></span>
    </div>
  </div>
  <div class="github-fork-ribbon-wrapper is-hidden-mobile is-hidden-print">
    <div class="github-fork-ribbon">
      <a href="https://github.com/textbook/textbook.github.io">
        <i class="fa fa-github fa-fw"></i>
        Fork me on GitHub
      </a>
    </div>
  </div>
</footer>

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-64837080-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = 'https://ssl.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'textbook-dev';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<script type="text/javascript">
  document.getElementById('navToggle').addEventListener('click', function () {
    var nav = document.getElementById('navMenu');
    var className = nav.getAttribute('class');
    if (className == 'navbar-menu') {
      nav.className = 'navbar-menu is-active';
    } else {
      nav.className = 'navbar-menu';
    }
  });
</script>
</body>
</html>